{% extends 'base.html' %}

{% block content %}
<div class="panel fade-in">
    <header class="panel-header mb-8">
        <h1 class="text-3xl font-bold">Preferences</h1>
        <p class="text-secondary">Customize your Tracker Pro experience</p>
    </header>

    <form id="preferences-form" method="post" action="/api/preferences/" class="space-y-8 max-w-2xl">
        <!-- Start of Week -->
        <div class="card p-6">
            <h3 class="font-bold mb-4">Calendar Settings</h3>

            <div class="form-group mb-6">
                <label class="form-label block mb-2 font-medium">Start of Week</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="radio-card cursor-pointer">
                        <input type="radio" name="start_of_week" value="0" class="hidden peer" {% if
                            preferences.start_of_week == 0 %}checked{% endif %}>
                        <div
                            class="p-4 rounded border border-border bg-surface peer-checked:border-primary peer-checked:bg-primary/5 transition-all text-center">
                            <span class="block font-bold mb-1">Monday</span>
                            <span class="text-xs text-secondary">ISO Standard</span>
                        </div>
                    </label>
                    <label class="radio-card cursor-pointer">
                        <input type="radio" name="start_of_week" value="6" class="hidden peer" {% if
                            preferences.start_of_week == 6 %}checked{% endif %}>
                        <div
                            class="p-4 rounded border border-border bg-surface peer-checked:border-primary peer-checked:bg-primary/5 transition-all text-center">
                            <span class="block font-bold mb-1">Sunday</span>
                            <span class="text-xs text-secondary">Traditional</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label block mb-2 font-medium">Default View</label>
                <select name="default_view" class="form-input w-full">
                    <option value="dashboard" {% if preferences.default_view == 'dashboard' %}selected{% endif %}>
                        Dashboard</option>
                    <option value="today" {% if preferences.default_view == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if preferences.default_view == 'week' %}selected{% endif %}>Week</option>
                    <option value="trackers" {% if preferences.default_view == 'trackers' %}selected{% endif %}>My
                        Trackers</option>
                </select>
                <p class="text-xs text-secondary mt-2">Where you'll land when you open the app.</p>
            </div>
        </div>

        <!-- Notifications -->
        <div class="card p-6">
            <h3 class="font-bold mb-4">Notifications</h3>

            <div class="space-y-4">
                <label class="flex items-center justify-between cursor-pointer">
                    <div>
                        <div class="font-medium">Push Notifications</div>
                        <div class="text-xs text-secondary">Receive alerts on your device</div>
                    </div>
                    <div class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="push_enabled" class="sr-only peer" {% if preferences.push_enabled
                            %}checked{% endif %}>
                        <div
                            class="w-11 h-6 bg-border peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                        </div>
                    </div>
                </label>

                <label class="flex items-center justify-between cursor-pointer">
                    <div>
                        <div class="font-medium">Email Summaries</div>
                        <div class="text-xs text-secondary">Weekly progress reports</div>
                    </div>
                    <div class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="email_notifications" class="sr-only peer" {% if
                            preferences.email_notifications %}checked{% endif %}>
                        <div
                            class="w-11 h-6 bg-border peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                        </div>
                    </div>
                </label>
            </div>
        </div>

        <div class="flex justify-end gap-4">
            <button type="button" class="btn" onclick="history.back()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
    </form>
</div>

<script>
    // Handle form submission via AJAX
    document.getElementById('preferences-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            });
            const data = await response.json();

            if (data.success) {
                showToast('Preferences saved successfully', 'success');
            } else {
                showToast('Failed to save preferences', 'error');
            }
        } catch (err) {
            console.error(err);
            showToast('An error occurred', 'error');
        }
    });

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.cookie.match(/csrftoken=([\w-]+)/)?.[1];
    }
</script>
{% endblock %}