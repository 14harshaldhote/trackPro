{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="main-content">
    <div class="card-header" style="border:none; padding:0; margin-bottom:2rem;">
        <div>
            <h1>Dashboard</h1>
            <p class="text-secondary">{{ today|date:"l, F j, Y" }}</p>
        </div>
        <a href="{% url 'create_tracker' %}" class="btn btn-primary">
            ‚ûï New Tracker
        </a>
    </div>

    <div class="grid-3">
        {% for item in trackers %}
        <div class="card">
            <div class="card-header" style="position: relative;">
                <div>
                    <h3>{{ item.tracker.name }}</h3>
                    <span class="badge badge-primary">{{ item.tracker.time_mode }}</span>
                </div>
                <button onclick="confirmDelete('{{ item.tracker.tracker_id }}', '{{ item.tracker.name }}')"
                    class="btn btn-ghost btn-sm"
                    style="position: absolute; top: 0.5rem; right: 0.5rem; color: #EF4444; padding: 0.25rem 0.5rem;"
                    title="Delete tracker">
                    üóëÔ∏è
                </button>
            </div>
            <p class="text-secondary">{{ item.tracker.description|default:"No description" }}</p>

            <div class="card-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ item.stats.total_tasks|default:"0" }}</div>
                    <div class="stat-label">Tasks</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ item.stats.completion_rate|default:"0"|floatformat:0 }}%</div>
                    <div class="stat-label">Done</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ item.stats.current_streak|default:"0" }}</div>
                    <div class="stat-label">Streak</div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                <a href="{% url 'today_view' item.tracker.tracker_id %}" class="btn btn-primary" style="flex: 1;">
                    üìÖ Today
                </a>
                <a href="{% url 'week_view' item.tracker.tracker_id %}" class="btn btn-ghost" style="flex: 1;">
                    üìä Week
                </a>
                <a href="{% url 'tracker_detail' item.tracker.tracker_id %}" class="btn btn-ghost" style="flex: 1;">
                    Details ‚Üí
                </a>
            </div>
        </div>
        {% empty %}
        <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
            <h3>No trackers yet</h3>
            <p class="text-secondary">Create your first tracker to get started.</p>
            <a href="{% url 'create_tracker' %}" class="btn btn-primary" style="margin-top: 1rem;">Create Tracker</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 400px; margin: 2rem;">
        <h3 style="margin-bottom: 1rem;">‚ö†Ô∏è Delete Tracker?</h3>
        <p class="text-secondary" style="margin-bottom: 1.5rem;">
            Are you sure you want to delete <strong id="trackerName"></strong>?
            This will permanently delete all tasks, history, and data. This action cannot be undone.
        </p>
        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
            <button onclick="closeDeleteModal()" class="btn btn-ghost">Cancel</button>
            <button onclick="deleteTracker()" class="btn" style="background: #EF4444; color: white;">Delete</button>
        </div>
    </div>
</div>

<script>
    let deleteTrackerId = null;

    function confirmDelete(trackerId, trackerName) {
        deleteTrackerId = trackerId;
        document.getElementById('trackerName').textContent = trackerName;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
        deleteTrackerId = null;
    }

    function deleteTracker() {
        if (!deleteTrackerId) return;

        showLoadingOverlay();

        fetch(`/tracker/${deleteTrackerId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                hideLoadingOverlay();
                if (data.status === 'success') {
                    showToast('Tracker deleted successfully', 'success');
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast(data.message || 'Failed to delete tracker', 'error');
                }
            })
            .catch(error => {
                hideLoadingOverlay();
                showToast('Error deleting tracker', 'error');
                console.error('Error:', error);
            });
    }

    function getCsrfToken() {
        // Get from Django template context first
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        if (token) return token.value;

        // Fallback to cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const trimmed = cookie.trim();
            if (trimmed.startsWith('csrftoken=')) {
                return trimmed.substring(10);
            }
        }
        return '';
    }
</script>
{% endblock %}