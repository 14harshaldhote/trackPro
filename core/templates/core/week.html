{% extends 'base.html' %}

{% block title %}Week View - {{ tracker.name }}{% endblock %}

{% block content %}
<div class="main-content fade-in">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <a href="{% url 'tracker_detail' tracker.tracker_id %}" class="btn btn-ghost">‚Üê Back</a>
                <h1 style="margin: 1rem 0;">üìä Week Overview</h1>
                <p class="text-secondary">{{ tracker.name }} - {{ week_start|date:"M j" }} to {{ week_end|date:"M j, Y" }}</p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="?week={{ prev_week }}" class="btn btn-ghost">‚Üê Previous</a>
                <a href="?week=0" class="btn btn-primary">This Week</a>
                <a href="?week={{ next_week }}" class="btn btn-ghost">Next ‚Üí</a>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid-3" style="margin-bottom: 2rem;">
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ done_tasks }}/{{ total_tasks }}</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ completion_rate|floatformat:0 }}%</div>
                <div class="stat-label">Week Progress</div>
            </div>
        </div>
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ grid_data|length }}</div>
                <div class="stat-label">Active Tasks</div>
            </div>
        </div>
    </div>

    <!-- Week Grid -->
    <div class="card" style="overflow-x: auto;">
        <table style="width: 100%; min-width: 800px; border-collapse: collapse;">
            <thead>
                <tr>
                    <th
                        style="position: sticky; left: 0; z-index: 2; background: var(--color-surface); padding: 1rem; min-width: 200px; border-right: 2px solid var(--color-border);">
                        Task
                    </th>
                    {% for day in week_days %}
                    <th
                        style="text-align: center; padding: 0.75rem; min-width: 100px; {% if day == today %}background: rgba(var(--color-primary-rgb, 2, 119, 189), 0.1);{% endif %}">
                        <div style="font-weight: 600; font-size: 0.875rem;">{{ day|date:"D" }}</div>
                        <div style="font-size: 0.75rem; color: var(--color-text-secondary); margin-top: 0.25rem;">
                            {{ day|date:"M j" }}
                        </div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in grid_data %}
                <tr style="border-bottom: 1px solid var(--color-border);">
                    <td
                        style="position: sticky; left: 0; z-index: 1; background: var(--color-surface); padding: 1rem; font-weight: 500; border-right: 2px solid var(--color-border);">
                        <div>{{ row.template.description }}</div>
                        {% if row.template.category %}
                        <span class="badge badge-primary" style="margin-top: 0.25rem; font-size: 0.7rem;">{{ row.template.category }}</span>
                        {% endif %}
                    </td>
                    {% for day_info in row.days %}
                    <td
                        style="text-align: center; padding: 0.5rem; {% if day_info.is_today %}background: rgba(var(--color-primary-rgb, 2, 119, 189), 0.05);{% endif %}">
                        {% if day_info.task %}
                        <button onclick="toggleStatus('{{ day_info.task.task_instance_id }}')" class="status-cell"
                            id="status-{{ day_info.task.task_instance_id }}" data-status="{{ day_info.status }}"
                            style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid 
                                {% if day_info.status == 'DONE' %}#10B981
                                {% elif day_info.status == 'IN_PROGRESS' %}#3B82F6
                                {% elif day_info.status == 'MISSED' %}#EF4444
                                {% elif day_info.status == 'BLOCKED' %}#F59E0B
                                {% else %}var(--color-border){% endif %}; 
                                background: {% if day_info.status == 'DONE' %}#10B981{% elif day_info.status == 'IN_PROGRESS' %}#3B82F6{% else %}transparent{% endif %}; 
                                cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                            {% if day_info.status == 'DONE' %}
                            <span style="color: white;">‚úì</span>
                            {% elif day_info.status == 'IN_PROGRESS' %}
                            <span style="color: white;">‚óê</span>
                            {% elif day_info.status == 'MISSED' %}
                            <span style="color: white;">‚úó</span>
                            {% elif day_info.status == 'BLOCKED' %}
                            <span style="color: white;">‚ö†</span>
                            {% else %}
                            <span style="color: var(--color-text-secondary);">‚óã</span>
                            {% endif %}
                        </button>
                        {% else %}
                        <div
                            style="width: 40px; height: 40px; opacity: 0.3; display: inline-flex; align-items: center; justify-content: center;">
                            -</div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="text-align: center; padding: 3rem;">
                        <p class="text-secondary">No tasks configured for this tracker.</p>
                        <a href="{% url 'create_tracker' %}" class="btn btn-primary" style="margin-top: 1rem;">
                            Create Tasks
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Legend -->
    <div class="card" style="margin-top: 2rem;">
        <h4 style="margin-bottom: 1rem;">Status Legend</h4>
        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div
                    style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid var(--color-border); background: transparent; display: flex; align-items: center; justify-content: center;">
                    <span style="color: var(--color-text-secondary); font-size: 0.875rem;">‚óã</span>
                </div>
                <span class="text-secondary">To Do</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div
                    style="width: 24px; height: 24px; border-radius: 4px; background: #3B82F6; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 0.875rem;">‚óê</span>
                </div>
                <span class="text-secondary">In Progress</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div
                    style="width: 24px; height: 24px; border-radius: 4px; background: #10B981; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 0.875rem;">‚úì</span>
                </div>
                <span class="text-secondary">Done</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div
                    style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #EF4444; background: #EF4444; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 0.875rem;">‚úó</span>
                </div>
                <span class="text-secondary">Missed</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div
                    style="width: 24px; height: 24px; border-radius: 4px; border: 2px solid #F59E0B; background: #F59E0B; display: flex; align-items: center; justify-content: center;">
                    <span style="color: white; font-size: 0.875rem;">‚ö†</span>
                </div>
                <span class="text-secondary">Blocked</span>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleStatus(taskId) {
        if (!taskId) return;

        const btn = document.getElementById('status-' + taskId);

        fetch(`/api/task/${taskId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload to update UI
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}