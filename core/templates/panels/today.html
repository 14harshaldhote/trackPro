{% extends 'base.html' %}

{% block content %}
<div class="panel fade-in">
    <!-- Enhanced Header with Sticky Navigation -->
    <header class="today-header">
        <div class="today-header-content">
            <div class="today-nav-controls">
                <a href="/today/?date={{ prev_day|date:'Y-m-d' }}" class="today-nav-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
                <div class="today-date-info">
                    <h2 class="today-title">
                        {% if is_today %}Today{% else %}{{ today|date:"l" }}{% endif %}
                    </h2>
                    <p class="today-subtitle">{{ today|date:"F j, Y" }}</p>
                </div>
                <a href="/today/?date={{ next_day|date:'Y-m-d' }}" class="today-nav-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
            </div>

            <!-- Enhanced Progress Ring -->
            <div class="today-progress-ring">
                <svg class="progress-svg" viewBox="0 0 48 48">
                    <circle class="progress-bg" cx="24" cy="24" r="20" />
                    <circle class="progress-bar" cx="24" cy="24" r="20"
                        style="stroke-dashoffset: calc(126 - (126 * {{ progress }} / 100))" />
                </svg>
                <span class="progress-text">{{ progress }}%</span>
            </div>
        </div>
    </header>

    {% if task_groups %}
    <div class="today-task-groups">
        {% for group in task_groups %}
        <div class="task-group-container">
            <div class="task-group-header">
                <h3 class="task-group-title">
                    <span class="task-group-icon">üìù</span>
                    {{ group.tracker.name }}
                </h3>
                <div class="task-group-stats">
                    <span class="task-group-count">{{ group.completed }}/{{ group.total }}</span>
                    <div class="task-group-progress-mini">
                        <div class="task-group-progress-fill"
                            style="width: {% widthratio group.completed group.total 100 %}%"></div>
                    </div>
                </div>
            </div>

            <div class="task-group-card">
                {% for task in group.tasks %}
                <div class="today-task-item {% if task.status == 'DONE' %}task-done{% endif %}"
                    data-task-id="{{ task.task_instance_id }}">

                    <!-- Checkbox Button -->
                    <button class="task-checkbox-btn {% if task.status == 'DONE' %}checked{% endif %}"
                        onclick="toggleTask('{{ task.task_instance_id }}')">
                        {% if task.status == 'DONE' %}
                        <svg class="checkmark" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        {% endif %}
                    </button>

                    <!-- Task Content -->
                    <div class="task-content-area"
                        onclick="window.openModal('edit-task', {task_id: '{{ task.task_instance_id }}'})">
                        <div class="task-description {% if task.status == 'DONE' %}completed{% endif %}">
                            {{ task.description }}
                        </div>
                        <div class="task-metadata">
                            {% if task.time_of_day %}
                            <span class="task-time-badge">
                                {% if task.time_of_day == 'morning' %}üåÖ
                                {% elif task.time_of_day == 'afternoon' %}‚òÄÔ∏è
                                {% elif task.time_of_day == 'evening' %}üåô
                                {% elif task.time_of_day == 'night' %}üåÉ
                                {% endif %}
                                <span>{{ task.time_of_day|capfirst }}</span>
                            </span>
                            {% endif %}
                            {% if task.category %}
                            <span class="task-category-badge">{{ task.category }}</span>
                            {% endif %}
                            {% if task.weight > 1 %}
                            <span class="task-weight-badge">{{ task.weight }}√ó</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Actions Dropdown -->
                    <div class="task-actions">
                        <div class="dropdown relative">
                            <button class="task-menu-btn" data-dropdown-toggle="task-{{ task.task_instance_id }}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="dropdown-menu right" id="dropdown-task-{{ task.task_instance_id }}">
                                <button class="dropdown-item"
                                    onclick="window.openModal('edit-task', {task_id: '{{ task.task_instance_id }}'})">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M12 20h9"></path>
                                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                                    </svg>
                                    Edit
                                </button>
                                <button class="dropdown-item"
                                    onclick="rescheduleTask('{{ task.task_instance_id }}', 'tomorrow')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                    Tomorrow
                                </button>
                                <button class="dropdown-item text-error"
                                    onclick="deleteTask('{{ task.task_instance_id }}')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path
                                            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                        </path>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Enhanced Empty State -->
    <div class="today-empty-state">
        <div class="empty-icon-container">
            <span class="empty-icon">üìÖ</span>
        </div>
        <h3 class="empty-title">All clear for today!</h3>
        <p class="empty-description">No tasks scheduled. Add a new task or check your trackers.</p>
        <button class="btn btn-primary btn-lg" onclick="window.openModal('add-task')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Task
        </button>
    </div>
    {% endif %}

    <!-- FAB -->
    <button class="today-fab" onclick="window.openModal('add-task')" title="Add task">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
</div>
{% endblock %}