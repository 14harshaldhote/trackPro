<!-- Goals Panel -->
<div class="panel goals-panel fade-in">
    <!-- Header -->
    <div class="panel-header">
        <div>
            <nav class="breadcrumb">
                <a href="/" data-nav>Dashboard</a>
                <span class="breadcrumb-separator">/</span>
                <span>Goals</span>
            </nav>
            <h1 class="panel-title">Goals</h1>
        </div>
        <div class="panel-actions">
            <button class="btn btn-primary" data-action="open-modal" data-modal="add-goal">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Goal
            </button>
        </div>
    </div>

    <!-- Active Goals -->
    <div class="goals-section">
        <h3 class="section-title">Active Goals</h3>
        <div class="goals-grid">
            {% for goal in active_goals %}
            <div class="goal-card {% if goal.progress >= 100 %}completed{% endif %}" data-goal-id="{{ goal.id }}">
                <div class="goal-header">
                    <span class="goal-icon">{{ goal.icon|default:'<svg width="20" height="20" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="6"></circle>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>'|safe }}</span>
                    <div class="goal-info">
                        <h4 class="goal-title">{{ goal.name }}</h4>
                        <span class="goal-tracker">{{ goal.tracker_name }}</span>
                    </div>
                    <button class="btn btn-icon btn-sm" data-action="context-menu">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="1"></circle>
                            <circle cx="12" cy="5" r="1"></circle>
                            <circle cx="12" cy="19" r="1"></circle>
                        </svg>
                    </button>
                </div>

                {% include 'partials/goal_progress.html' with progress=goal.progress target=goal.target
                current=goal.current %}

                <div class="goal-stats">
                    <div class="goal-stat">
                        <span class="goal-stat-value">{{ goal.current }}</span>
                        <span class="goal-stat-label">of {{ goal.target }} {{ goal.unit }}</span>
                    </div>
                    <div class="goal-stat">
                        <span class="goal-stat-value">{{ goal.days_left }}</span>
                        <span class="goal-stat-label">days left</span>
                    </div>
                </div>

                <div class="goal-forecast">
                    {% if goal.on_track %}
                    <span class="on-track">‚úì On track</span>
                    {% else %}
                    <span class="behind">‚ö† {{ goal.behind_by }} behind pace</span>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="6"></circle>
                        <circle cx="12" cy="12" r="2"></circle>
                    </svg>
                </div>
                <h3>No Active Goals</h3>
                <p>Set a goal to stay motivated and track your progress.</p>
                <button class="btn btn-primary" data-action="open-modal" data-modal="add-goal">Create Goal</button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Completed Goals -->
    {% if completed_goals %}
    <div class="goals-section">
        <h3 class="section-title">üèÜ Completed Goals</h3>
        <div class="completed-goals-list">
            {% for goal in completed_goals %}
            <div class="completed-goal-item">
                <span class="goal-icon">{{ goal.icon|default:'<svg width="20" height="20" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>'|safe }}</span>
                <div class="goal-info">
                    <span class="goal-name">{{ goal.name }}</span>
                    <span class="goal-completed-date">Completed {{ goal.completed_at|timesince }} ago</span>
                </div>
                <span class="goal-celebration">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5.8 11.3 2 22l10.7-3.79"></path>
                        <path d="M4 3h.01"></path>
                        <path d="M22 8h.01"></path>
                        <path d="M15 2h.01"></path>
                        <path d="M22 20h.01"></path>
                        <path
                            d="m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12v0c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10">
                        </path>
                        <path d="m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11v0c-.11.7-.72 1.22-1.43 1.22H17"></path>
                        <path d="m11 2 .33.82c.34.86-.2 1.82-1.11 1.98v0C9.52 4.9 9 5.52 9 6.23V7"></path>
                    </svg>
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Goal Types Guide -->
    <div class="goal-types-section">
        <h3 class="section-title">Goal Types</h3>
        <div class="goal-types-grid">
            <div class="goal-type-card">
                <span class="goal-type-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                </span>
                <h4>Complete X Tasks</h4>
                <p>Complete a specific number of tasks within a timeframe.</p>
            </div>
            <div class="goal-type-card">
                <span class="goal-type-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.1 1-2.2 2.5-3.2.5 1 1.5 2 2 3z">
                        </path>
                    </svg>
                </span>
                <h4>Streak Goal</h4>
                <p>Maintain a streak for a set number of consecutive days.</p>
            </div>
            <div class="goal-type-card">
                <span class="goal-type-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                </span>
                <h4>Completion Rate</h4>
                <p>Achieve a target completion percentage over time.</p>
            </div>
        </div>
    </div>
</div>

<!-- Confetti Container -->
<canvas id="confetti-canvas" class="confetti-canvas"></canvas>

<script>
    (function initGoalsPanel() {
        'use strict';

        const container = document.querySelector('.goals-panel');
        if (!container) return;

        // ===== GOAL CARD CLICK HANDLING =====
        const goalCards = container.querySelectorAll('.goal-card');
        goalCards.forEach(card => {
            const menuBtn = card.querySelector('[data-action="context-menu"]');
            if (menuBtn) {
                menuBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const goalId = card.dataset.goalId;
                    // Open edit modal instead of showing context menu
                    if (window.App) {
                        window.App.loadModal(`/modals/edit_goal/?goal_id=${goalId}`);
                    }
                });
            }
        });

        // ===== LOAD GOALS VIA API =====
        async function loadGoals() {
            if (!window.apiClient) {
                console.log('[Goals] apiClient not available, using server-rendered data');
                return;
            }

            try {
                // API v1: /api/v1/goals/
                const result = await window.apiClient.get('/goals/');

                if (result.success) {
                    console.log('[Goals] Loaded goals:', result.goals);
                    // Could dynamically update UI here if needed
                    // For now, server-side rendering handles initial load
                    return result.goals;
                } else {
                    throw new Error(result.error || 'Failed to load goals');
                }
            } catch (error) {
                console.error('[Goals] Failed to load goals:', error);
                if (window.App) {
                    window.App.showToast('error', 'Failed to load goals');
                }
                throw error;
            }
        }

        // ===== CONFETTI ANIMATION =====
        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const confetti = [];
            const colors = ['#6366f1', '#22c55e', '#f97316', '#ec4899', '#0ea5e9'];

            // Create confetti particles
            for (let i = 0; i < 100; i++) {
                confetti.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speedY: Math.random() * 3 + 2,
                    speedX: Math.random() * 2 - 1,
                    rotation: Math.random() * 360
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                confetti.forEach((particle, index) => {
                    ctx.save();
                    ctx.translate(particle.x, particle.y);
                    ctx.rotate(particle.rotation * Math.PI / 180);
                    ctx.fillStyle = particle.color;
                    ctx.fillRect(-particle.size / 2, -particle.size / 2, particle.size, particle.size);
                    ctx.restore();

                    particle.y += particle.speedY;
                    particle.x += particle.speedX;
                    particle.rotation += 5;

                    if (particle.y > canvas.height) {
                        confetti.splice(index, 1);
                    }
                });

                if (confetti.length > 0) {
                    requestAnimationFrame(animate);
                } else {
                    canvas.style.display = 'none';
                }
            }

            canvas.style.display = 'block';
            animate();

            // Hide after 3 seconds (reduced from 5)
            setTimeout(() => {
                canvas.style.display = 'none';
            }, 3000);
        }

        // Check if we just completed a goal (from URL param or localStorage)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('goal_completed')) {
            setTimeout(triggerConfetti, 500);
        }

        // Load goals data in background if apiClient available
        if (window.apiClient) {
            loadGoals().catch(err => {
                console.log('[Goals] Initial goal load failed, using server-rendered data:', err);
            });
        }

        console.log('[Goals] Panel initialized with API v1 support');
    })();
</script>