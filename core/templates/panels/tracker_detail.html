{% extends 'base.html' %}

{% block content %}
<div class="panel fade-in">
    <!-- Header -->
    <header class="panel-header mb-6">
        <div class="flex items-center gap-2 text-secondary text-sm mb-2">
            <a href="/trackers/" class="hover:text-primary transition-colors">Trackers</a>
            <span>/</span>
            <span>{{ tracker.name }}</span>
        </div>
        <div class="flex justify-between items-start gap-4">
            <div class="flex-1">
                <h1 class="text-3xl font-bold flex items-center gap-3 flex-wrap">
                    {{ tracker.name }}
                    <span class="tracker-period-badge">
                        {{ tracker.time_period }}
                    </span>
                </h1>
                {% if tracker.description %}
                <p class="text-secondary mt-2 max-w-2xl">{{ tracker.description }}</p>
                {% endif %}
            </div>
            <div class="flex gap-2 flex-shrink-0">
                <button class="btn"
                    onclick="window.openModal('edit-tracker', {tracker_id: '{{ tracker.tracker_id }}'})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                    </svg>
                    Edit
                </button>
                <button class="btn btn-primary"
                    onclick="window.openModal('add-task', {tracker_id: '{{ tracker.tracker_id }}'})">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add Task
                </button>
            </div>
        </div>
    </header>

    <!-- Quick Stats with data attributes for AJAX updates -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" data-tracker-stats="{{ tracker.tracker_id }}">
        <div class="stat-card card">
            <div class="stat-value" data-stat="progress-value">{{ progress }}%</div>
            <div class="stat-label">Progress Today</div>
            <div class="progress-bar mt-2">
                <div class="progress-fill" data-stat="progress-bar" style="width: {{ progress }}%"></div>
            </div>
        </div>
        <div class="stat-card card">
            <div class="stat-value">
                <span data-stat="completed-count">{{ completed_count }}</span>/<span data-stat="task-count">{{
                    task_count }}</span>
            </div>
            <div class="stat-label">Tasks Done</div>
        </div>
        <div class="stat-card card">
            <div class="stat-value">{{ stats.current_streak }}</div>
            <div class="stat-label">Current Streak</div>
        </div>
        <div class="stat-card card">
            <div class="stat-value">{{ stats.best_streak }}</div>
            <div class="stat-label">Best Streak</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Column: Tasks -->
        <div class="lg:col-span-2">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Today's Tasks</h2>
                <div class="btn-group text-sm">
                    <a href="/tracker/{{ tracker.tracker_id }}/?group=status"
                        class="btn btn-sm {% if group_by == 'status' or not group_by %}btn-primary{% endif %}">
                        Status
                    </a>
                    <a href="/tracker/{{ tracker.tracker_id }}/?group=category"
                        class="btn btn-sm {% if group_by == 'category' %}btn-primary{% endif %}">
                        Category
                    </a>
                </div>
            </div>

            {% if tasks %}
            <div class="card overflow-hidden mb-6">
                <div class="divide-y divide-border" id="tasks-container">
                    {% for task in tasks %}
                    <div class="task-item p-4 flex items-center gap-4 hover:bg-surface-hover transition-all group"
                        data-task-id="{{ task.task_instance_id }}">
                        <label class="task-checkbox">
                            <input type="checkbox" {% if task.status == 'DONE' %}checked{% endif %}
                                data-task-id="{{ task.task_instance_id }}" data-tracker-id="{{ tracker.tracker_id }}">
                            <span class="checkbox-mark"></span>
                        </label>
                        <div class="flex-1 cursor-pointer"
                            onclick="window.openModal('edit-task', {task_id: '{{ task.task_instance_id }}'})">
                            <div
                                class="task-content {% if task.status == 'DONE' %}line-through text-secondary{% endif %}">
                                {{ task.template.description }}
                            </div>
                            <div class="task-metadata">
                                {% if task.template.category %}
                                <span class="badge badge-sm">{{ task.template.category }}</span>
                                {% endif %}
                                <span class="task-time">{{ task.template.time_of_day|default:"anytime"|capfirst }}</span>
                                {% if task.template.weight > 1 %}
                                <span class="task-weight">Weight: {{ task.template.weight }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <button class="btn-icon opacity-0 group-hover:opacity-100 transition-opacity"
                            onclick="window.openModal('edit-task', {task_id: '{{ task.task_instance_id }}'})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 20h9"></path>
                                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                            </svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="empty-state card p-8 text-center bg-surface-alt mb-6">
                <div class="text-4xl mb-3">üìù</div>
                <p class="text-secondary mb-4">No tasks scheduled for today.</p>
                <button class="btn btn-primary btn-sm"
                    onclick="window.openModal('add-task', {tracker_id: '{{ tracker.tracker_id }}'})">
                    Add Your First Task
                </button>
            </div>
            {% endif %}

            <!-- Historical Tasks -->
            {% if historical_tasks %}
            <div class="mt-8">
                <h3 class="font-bold mb-4 text-lg">Previous 30 Days</h3>
                <div class="space-y-2">
                    {% for task in historical_tasks %}
                    <div
                        class="task-history-item card p-3 flex items-center justify-between hover:bg-surface-hover transition-colors">
                        <div class="flex items-center gap-3">
                            <div
                                class="task-status-dot {% if task.status == 'DONE' %}status-done{% else %}status-pending{% endif %}">
                            </div>
                            <span class="text-secondary text-sm">{{ task.tracker_instance.period_start|date:"M j"
                                }}</span>
                            <span class="{% if task.status == 'DONE' %}line-through text-secondary{% endif %}">
                                {{ task.template.description }}
                            </span>
                        </div>
                        <span class="badge badge-sm {% if task.status == 'DONE' %}badge-success{% endif %}">
                            {{ task.status }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar Column: Insights & Details -->
        <div class="lg:col-span-1 space-y-6">
            {% if top_insight %}
            <div class="insight-card card p-4">
                <h3 class="insight-header">
                    <span class="insight-icon">üí°</span>
                    Insight
                </h3>
                <p class="insight-message">{{ top_insight.message }}</p>
            </div>
            {% endif %}

            <div class="card p-4">
                <h3 class="font-bold mb-4">Time Distribution</h3>
                <div class="space-y-3">
                    {% for time, count in time_distribution.items %}
                    {% if count > 0 %}
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="capitalize">{{ time }}</span>
                            <span>{{ count }} task{{ count|pluralize }}</span>
                        </div>
                        <div class="h-1.5 bg-bg rounded overflow-hidden">
                            <div class="h-full bg-primary transition-all"
                                style="width: {% widthratio count task_count 100 %}%"></div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Archive Action -->
            <div class="card p-4 border-l-4 border-l-warning">
                <h4 class="font-bold text-sm mb-2">Tracker Actions</h4>
                <button class="btn btn-sm w-full text-error border-error hover:bg-error hover:text-white"
                    onclick="archiveTracker('{{ tracker.tracker_id }}')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Archive This Tracker
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Listen for task toggle events and update stats
    document.addEventListener('click', async (e) => {
        const checkbox = e.target.closest('input[type="checkbox"][data-task-id][data-tracker-id]');
        if (!checkbox) return;

        const trackerId = checkbox.dataset.trackerId;

        // Wait a bit for the task toggle to complete
        setTimeout(async () => {
            try {
                // Recalculate stats from DOM
                const tasksContainer = document.getElementById('tasks-container');
                if (!tasksContainer) return;

                const allTasks = tasksContainer.querySelectorAll('.task-item');
                const completedTasks = tasksContainer.querySelectorAll('input[type="checkbox"]:checked');

                const total = allTasks.length;
                const completed = completedTasks.length;
                const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

                // Update stats using trackers module
                if (window.app?.modules?.trackers) {
                    window.app.modules.trackers.updateTrackerStats(trackerId, {
                        progress: progress,
                        completed: completed,
                        total: total
                    });
                }
            } catch (error) {
                console.error('[TrackerDetail] Failed to update stats:', error);
            }
        }, 500);
    });
</script>
{% endblock %}