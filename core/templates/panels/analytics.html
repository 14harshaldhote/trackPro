<!-- Analytics Panel -->
<div class="panel analytics-panel fade-in">
    <!-- Header -->
    <div class="panel-header">
        <div>
            <nav class="breadcrumb">
                <a href="/" data-nav>Dashboard</a>
                <span class="breadcrumb-separator">/</span>
                <span>Analytics</span>
            </nav>
            <h1 class="panel-title">Analytics</h1>
        </div>
        <div class="panel-actions">
            <!-- Time Range Selector -->
            <div class="time-range-selector" role="group" aria-label="Time range">
                <button class="range-btn" data-range="7">7D</button>
                <button class="range-btn active" data-range="30">30D</button>
                <button class="range-btn" data-range="90">90D</button>
                <button class="range-btn" data-range="365">1Y</button>
            </div>

            <button class="btn btn-ghost" id="export-charts">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export
            </button>
        </div>
    </div>

    <!-- Insights Banner -->
    {% include 'partials/insight_banner.html' %}

    <!-- Stats Overview -->
    <div class="analytics-stats">
        <div class="analytics-stat">
            <div class="stat-value">{{ overview.completion_rate|floatformat:0 }}%</div>
            <div class="stat-label">Completion Rate</div>
            <div class="stat-change {% if week_comparison.change >= 0 %}positive{% else %}negative{% endif %}">
                {{ week_comparison.change|floatformat:1 }}% vs last week
            </div>
        </div>
        <div class="analytics-stat">
            <div class="stat-value">{{ overview.completed_tasks }}</div>
            <div class="stat-label">Tasks Done</div>
        </div>
        <div class="analytics-stat">
            <div class="stat-value">{{ overview.streak|default:0 }}</div>
            <div class="stat-label">Best Streak <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.1 1-2.2 2.5-3.2.5 1 1.5 2 2 3z">
                    </path>
                </svg></div>
        </div>
        <div class="analytics-stat">
            <div class="stat-value">{{ overview.avg_per_day|floatformat:1|default:"0.0" }}</div>
            <div class="stat-label">Avg/Day</div>
        </div>
    </div>

    <!-- Main Chart Area -->
    <div class="chart-section">
        <div class="chart-header">
            <h3>Completion Trend</h3>
            <div class="chart-type-toggle">
                <button class="chart-type-btn active" data-type="line">Line</button>
                <button class="chart-type-btn" data-type="bar">Bar</button>
            </div>
        </div>
        <div class="chart-container" id="completion-chart-container">
            {% include 'partials/chart_line.html' with chart_id="completion-chart" %}
        </div>
    </div>

    <!-- Two Column Charts -->
    <div class="charts-grid">
        <!-- Category Breakdown -->
        <div class="chart-section">
            <div class="chart-header">
                <h3>By Category</h3>
            </div>
            <div class="chart-container chart-container-sm">
                {% include 'partials/chart_pie.html' with chart_id="category-chart" %}
            </div>
        </div>

        <!-- Time of Day -->
        <div class="chart-section">
            <div class="chart-header">
                <h3>By Time of Day</h3>
            </div>
            <div class="chart-container chart-container-sm">
                {% include 'partials/chart_bar.html' with chart_id="time-chart" %}
            </div>
        </div>
    </div>

    <!-- Heatmap -->
    <div class="chart-section">
        <div class="chart-header">
            <h3>Activity Heatmap</h3>
            <span class="text-muted">Contributions in the last year</span>
        </div>
        {% include 'partials/chart_heatmap.html' %}
    </div>

    <!-- Tracker Comparison -->
    <div class="chart-section">
        <div class="chart-header">
            <h3>Tracker Comparison</h3>
            <div class="comparison-selectors">
                <select id="compare-tracker-1" class="form-select form-select-sm">
                    {% for tracker in trackers %}
                    <option value="{{ tracker.id }}">{{ tracker.name }}</option>
                    {% endfor %}
                </select>
                <span class="text-muted">vs</span>
                <select id="compare-tracker-2" class="form-select form-select-sm">
                    <option value="">Select tracker</option>
                    {% for tracker in trackers %}
                    <option value="{{ tracker.id }}">{{ tracker.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="chart-container" id="comparison-chart-container">
            {% include 'partials/chart_line.html' with chart_id="comparison-chart" multi=True %}
        </div>
    </div>

    <!-- Forecast -->
    <div class="forecast-section">
        <div class="forecast-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <path
                    d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z">
                </path>
            </svg>
        </div>
        <div class="forecast-content">
            <h4>Forecast</h4>
            <p>{{ forecast.message }}</p>
            <p class="text-muted text-sm">Based on your {{ forecast.days_analyzed }} day trend</p>
        </div>
    </div>
</div>

<script>
    (function initAnalyticsPanel() {
        'use strict';

        const container = document.querySelector('.analytics-panel');
        if (!container) return;

        let currentRange = 30; // Default range in days
        let chartInstances = {}; // Store chart instances for updates

        // ===== TIME RANGE SELECTOR =====
        const rangeButtons = container.querySelectorAll('.range-btn');
        rangeButtons.forEach(btn => {
            btn.addEventListener('click', async function () {
                // Update active state
                rangeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Update current range
                currentRange = parseInt(this.dataset.range);

                // Disable buttons during load
                rangeButtons.forEach(b => b.disabled = true);

                try {
                    // Reload charts with new range
                    await loadAllCharts();
                } catch (error) {
                    console.error('[Analytics] Failed to load charts for range:', error);
                    if (window.App) {
                        window.App.showToast('error', 'Failed to load analytics data');
                    }
                } finally {
                    // Re-enable buttons
                    rangeButtons.forEach(b => b.disabled = false);
                }
            });
        });

        // ===== CHART TYPE TOGGLE =====
        const chartTypeBtns = container.querySelectorAll('.chart-type-btn');
        chartTypeBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const parent = this.closest('.chart-section');
                parent.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const chartType = this.dataset.type;
                // Update chart type - would need chart library to implement
                console.log('[Analytics] Chart type changed to:', chartType);
            });
        });

        // ===== TRACKER COMPARISON =====
        const compareTracker1 = container.querySelector('#compare-tracker-1');
        const compareTracker2 = container.querySelector('#compare-tracker-2');

        if (compareTracker1 && compareTracker2) {
            [compareTracker1, compareTracker2].forEach(select => {
                select.addEventListener('change', async () => {
                    const tracker1 = compareTracker1.value;
                    const tracker2 = compareTracker2.value;

                    if (tracker1 && tracker2) {
                        await loadComparisonChart(tracker1, tracker2);
                    }
                });
            });
        }

        // ===== LOAD CHARTS FROM API =====
        async function loadAllCharts() {
            if (!window.apiClient) {
                console.log('[Analytics] apiClient not available, using server-rendered data');
                return;
            }

            // Show loading states
            const chartContainers = container.querySelectorAll('.chart-container');
            chartContainers.forEach(c => {
                c.setAttribute('aria-busy', 'true');
                c.style.opacity = '0.5';
            });

            try {
                // Load completion trend chart
                await loadChartData('completion', 'completion-chart-container');

                // Load category breakdown
                await loadChartData('pie', 'category-chart');

                // Load time of day chart
                await loadChartData('bar', 'time-chart');

                console.log('[Analytics] Charts loaded successfully');
            } catch (error) {
                console.error('[Analytics] Failed to load charts:', error);
                if (window.App) {
                    window.App.showToast('error', 'Failed to load chart data');
                }
                throw error;
            } finally {
                // Remove loading states
                chartContainers.forEach(c => {
                    c.setAttribute('aria-busy', 'false');
                    c.style.opacity = '1';
                });
            }
        }

        async function loadChartData(chartType, containerId, trackerId = null) {
            if (!window.apiClient) {
                console.warn('[Analytics] apiClient not available');
                return;
            }

            try {
                const params = {
                    type: chartType,
                    days: currentRange
                };

                if (trackerId) {
                    params.tracker_id = trackerId;
                }

                // API v1: /api/v1/chart-data/
                const result = await window.apiClient.get('/chart-data/', params);

                if (result.success) {
                    console.log(`[Analytics] Loaded ${chartType} chart data:`, result.data);
                    // Chart rendering would go here with a library like Chart.js
                    // For now, just log the data
                    // TODO: Implement actual chart rendering when Chart.js is added
                } else {
                    throw new Error(result.error || 'Failed to load chart data');
                }
            } catch (error) {
                console.error(`[Analytics] Failed to load ${chartType} chart:`, error);
                if (window.App) {
                    window.App.showToast('error', `Failed to load ${chartType} chart`);
                }
                throw error;
            }
        }

        async function loadComparisonChart(tracker1Id, tracker2Id) {
            if (!window.apiClient) {
                console.warn('[Analytics] apiClient not available');
                return;
            }

            const comparisonContainer = container.querySelector('#comparison-chart-container');
            if (comparisonContainer) {
                comparisonContainer.setAttribute('aria-busy', 'true');
                comparisonContainer.style.opacity = '0.5';
            }

            try {
                // Load data for both trackers
                const [data1, data2] = await Promise.all([
                    window.apiClient.get('/chart-data/', {
                        type: 'completion',
                        tracker_id: tracker1Id,
                        days: currentRange
                    }),
                    window.apiClient.get('/chart-data/', {
                        type: 'completion',
                        tracker_id: tracker2Id,
                        days: currentRange
                    })
                ]);

                if (data1.success && data2.success) {
                    console.log('[Analytics] Comparison data loaded:', { data1, data2 });
                    // Render comparison chart here with Chart.js when available
                    // TODO: Implement multi-dataset chart rendering
                } else {
                    throw new Error('Failed to load comparison data');
                }
            } catch (error) {
                console.error('[Analytics] Failed to load comparison:', error);
                if (window.App) {
                    window.App.showToast('error', 'Failed to load comparison');
                }
            } finally {
                if (comparisonContainer) {
                    comparisonContainer.setAttribute('aria-busy', 'false');
                    comparisonContainer.style.opacity = '1';
                }
            }
        }

        // ===== EXPORT CHARTS =====
        const exportBtn = container.querySelector('#export-charts');
        if (exportBtn) {
            exportBtn.addEventListener('click', async () => {
                exportBtn.disabled = true;
                exportBtn.setAttribute('aria-busy', 'true');
                const originalHTML = exportBtn.innerHTML;
                exportBtn.innerHTML = '<span class="loading-spinner" style="width:14px;height:14px;"></span> Exporting...';

                try {
                    // TODO: Implement actual chart export when Chart.js is added
                    // For now, show placeholder success
                    await new Promise(resolve => setTimeout(resolve, 500)); // Simulate export

                    if (window.App) {
                        window.App.showToast('success', 'Charts exported');
                    }
                } catch (error) {
                    console.error('[Analytics] Export failed:', error);
                    if (window.App) {
                        window.App.showToast('error', 'Export failed');
                    }
                } finally {
                    exportBtn.disabled = false;
                    exportBtn.setAttribute('aria-busy', 'false');
                    exportBtn.innerHTML = originalHTML;
                }
            });
        }

        // Load initial charts in background if apiClient available
        if (window.apiClient) {
            loadAllCharts().catch(err => {
                console.log('[Analytics] Initial chart load failed, using server-rendered data:', err);
            });
        }

        console.log('[Analytics] Panel initialized with API v1 support');
    })();
</script>