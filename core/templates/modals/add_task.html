<!-- Add Task Modal -->
<div class="modal-dialog" role="document">
    <div class="modal-header">
        <h3 class="modal-title">Add New Task</h3>
        <button type="button" class="modal-close" data-action="close-modal" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <form id="add-task-form" method="POST" data-ajax>
        {% csrf_token %}

        <div class="modal-body">
            <!-- Select Tracker -->
            <div class="form-group">
                <label for="tracker-select" class="form-label">Select Tracker *</label>
                <select id="tracker-select" name="tracker_id" class="form-select" required>
                    <option value="">Choose a tracker...</option>
                    {% for tracker in trackers %}
                    <option value="{{ tracker.tracker_id }}">{{ tracker.name }}</option>
                    {% empty %}
                    <option value="" disabled>No trackers available</option>
                    {% endfor %}
                </select>
                <div class="field-error" id="tracker-error"></div>
            </div>

            <!-- Task Description -->
            <div class="form-group">
                <label for="task-description" class="form-label">Task Description *</label>
                <input type="text" id="task-description" name="description" class="form-input"
                    placeholder="What do you want to track?" required maxlength="200" autofocus>
                <div class="hint">e.g., Drink 8 glasses of water, 30 min exercise, Read 20 pages</div>
                <div class="field-error" id="description-error"></div>
            </div>

            <!-- Category -->
            <div class="form-group">
                <label for="task-category" class="form-label">Category</label>
                <input type="text" id="task-category" name="category" class="form-input"
                    placeholder="e.g., health, focus, learning" maxlength="50" list="category-suggestions">
                <datalist id="category-suggestions">
                    <option value="health">
                    <option value="fitness">
                    <option value="mindfulness">
                    <option value="learning">
                    <option value="focus">
                    <option value="nutrition">
                    <option value="sleep">
                    <option value="planning">
                    <option value="review">
                </datalist>
            </div>

            <!-- Weight / Importance -->
            <div class="form-group">
                <label for="task-weight" class="form-label">
                    Importance
                    <span class="label-hint">(affects completion %)</span>
                </label>
                <div class="weight-selector">
                    <label class="weight-option">
                        <input type="radio" name="weight" value="1" checked>
                        <span class="weight-badge">1</span>
                        <span class="weight-label">Low</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="2">
                        <span class="weight-badge">2</span>
                        <span class="weight-label">Medium</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="3">
                        <span class="weight-badge">3</span>
                        <span class="weight-label">High</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="5">
                        <span class="weight-badge">5</span>
                        <span class="weight-label">Critical</span>
                    </label>
                </div>
            </div>

            <!-- Schedule -->
            <div class="form-group">
                <label class="form-label">Schedule</label>
                <div class="schedule-options">
                    <label class="form-checkbox inline">
                        <input type="checkbox" name="is_recurring" id="is-recurring" checked>
                        <span>Recurring (repeat daily)</span>
                    </label>
                </div>
            </div>

            <!-- Time of Day (Optional) -->
            <div class="form-group">
                <label for="task-time" class="form-label">Preferred Time (Optional)</label>
                <select id="task-time" name="time_of_day" class="form-select">
                    <option value="">Any time</option>
                    <option value="morning">üåÖ Morning (6am-12pm)</option>
                    <option value="afternoon">‚òÄÔ∏è Afternoon (12pm-5pm)</option>
                    <option value="evening">üåÜ Evening (5pm-9pm)</option>
                    <option value="night">üåô Night (9pm-12am)</option>
                </select>
            </div>

            <!-- Link to Goal (Optional) -->
            <div class="form-group">
                <label for="task-goal" class="form-label">Link to Goal (Optional)</label>
                <select id="task-goal" name="goal_id" class="form-select">
                    <option value="">No goal linked</option>
                    <!-- Goals populated dynamically -->
                </select>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="create-task-btn">
                Add Task
            </button>
        </div>
    </form>
</div>

<style>
    .hint {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        margin-top: 0.25rem;
    }

    .label-hint {
        font-weight: 400;
        color: var(--color-text-secondary);
        font-size: 0.75rem;
    }

    .weight-selector {
        display: flex;
        gap: 0.5rem;
    }

    .weight-option {
        flex: 1;
        cursor: pointer;
    }

    .weight-option input {
        display: none;
    }

    .weight-option span {
        display: block;
        text-align: center;
    }

    .weight-badge {
        width: 100%;
        padding: 0.5rem;
        background: var(--color-bg);
        border: 2px solid var(--color-border);
        border-radius: 8px 8px 0 0;
        font-weight: 700;
        font-size: 1.25rem;
        transition: all 0.2s;
    }

    .weight-label {
        padding: 0.25rem;
        background: var(--color-bg);
        border: 2px solid var(--color-border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        font-size: 0.625rem;
        font-weight: 500;
        text-transform: uppercase;
        color: var(--color-text-secondary);
        transition: all 0.2s;
    }

    .weight-option input:checked+.weight-badge {
        border-color: var(--color-primary);
        background: var(--color-primary);
        color: white;
    }

    .weight-option input:checked~.weight-label {
        border-color: var(--color-primary);
        color: var(--color-primary);
    }

    .weight-option:hover .weight-badge {
        border-color: var(--color-primary);
    }

    .schedule-options {
        display: flex;
        gap: 1rem;
    }

    .form-checkbox.inline {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }



    .form-checkbox.inline span {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }
</style>
<script>
    (function () {
        // Add Task Modal - Form Submission Handler
        const form = document.getElementById('add-task-form');
        const submitBtn = document.getElementById('create-task-btn');
        const trackerSelect = document.getElementById('tracker-select');
        const descriptionInput = document.getElementById('task-description');

        if (!form) {
            console.error('[AddTaskModal] Form not found');
            return;
        }

        // Get tracker ID from the select dropdown or URL
        function getTrackerId() {
            // First check the select dropdown
            if (trackerSelect && trackerSelect.value) {
                return trackerSelect.value;
            }

            // Try to get from URL (e.g., /tracker/xxx/)
            const match = window.location.pathname.match(/\/tracker\/([^/]+)\//);
            if (match) {
                // Pre-select in dropdown if available
                if (trackerSelect) {
                    trackerSelect.value = match[1];
                }
                return match[1];
            }

            // Try to get from App state (if using SPA)
            if (window.App && window.App.state && window.App.state.currentTracker) {
                if (trackerSelect) {
                    trackerSelect.value = window.App.state.currentTracker;
                }
                return window.App.state.currentTracker;
            }

            return null;
        }

        // Pre-select tracker if on tracker detail page
        const preselectedTrackerId = window.location.pathname.match(/\/tracker\/([^/]+)\//)?.[1] ||
            (window.App?.state?.currentTracker);
        if (preselectedTrackerId && trackerSelect) {
            trackerSelect.value = preselectedTrackerId;
        }

        // Handle form submission
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const trackerId = getTrackerId();

            if (!trackerId) {
                if (window.App) {
                    window.App.showToast('error', 'No Tracker Selected', 'Please select a tracker first');
                } else {
                    alert('Please select a tracker first');
                }
                return;
            }

            const description = descriptionInput.value.trim();
            if (!description) {
                document.getElementById('description-error').textContent = 'Description is required';
                return;
            }

            // Disable button during submission
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span> Adding...';
            }

            try {
                const formData = new FormData(form);
                const data = {
                    description: formData.get('description'),
                    category: formData.get('category') || '',
                    weight: parseInt(formData.get('weight')) || 1,
                    time_of_day: formData.get('time_of_day') || '',
                    is_recurring: formData.has('is_recurring'),
                    goal_id: formData.get('goal_id') || null
                };

                // Get CSRF token
                const csrfToken = formData.get('csrfmiddlewaretoken') ||
                    document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                    (window.App ? window.App.getCsrfToken() : '');

                const response = await fetch(`/api/tracker/${trackerId}/task/add/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    if (window.App) {
                        window.App.showToast('success', 'Task Added', result.message || 'Task created successfully');
                        window.App.closeModal();
                        // Refresh the current panel
                        window.App.cache.panels.delete(window.location.pathname);
                        window.App.loadPanel(window.location.pathname, false);
                    } else {
                        alert('Task added successfully!');
                        window.location.reload();
                    }
                } else {
                    throw new Error(result.error || 'Failed to add task');
                }
            } catch (error) {
                console.error('[AddTaskModal] Submit error:', error);
                if (window.App) {
                    window.App.showToast('error', 'Error', error.message);
                } else {
                    alert('Error: ' + error.message);
                }
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Add Task';
                }
            }
        });

        console.log('[AddTaskModal] Form handler initialized');
    })();
</script>