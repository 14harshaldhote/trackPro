<!-- Add Task Modal -->
<div class="modal-dialog" role="document">
    <div class="modal-header">
        <h3 class="modal-title">Add New Task</h3>
        <button type="button" class="modal-close" data-action="close-modal" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <form id="add-task-form" method="POST" data-ajax>
        <input type="hidden" name="tracker_id" id="tracker-id">

        <div class="modal-body">
            <!-- Task Description -->
            <div class="form-group">
                <label for="task-description" class="form-label">Task Description *</label>
                <input type="text" id="task-description" name="description" class="form-input"
                    placeholder="What do you want to track?" required maxlength="200" autofocus>
                <div class="hint">e.g., Drink 8 glasses of water, 30 min exercise, Read 20 pages</div>
                <div class="field-error" id="description-error"></div>
            </div>

            <!-- Category -->
            <div class="form-group">
                <label for="task-category" class="form-label">Category</label>
                <input type="text" id="task-category" name="category" class="form-input"
                    placeholder="e.g., health, focus, learning" maxlength="50" list="category-suggestions">
                <datalist id="category-suggestions">
                    <option value="health">
                    <option value="fitness">
                    <option value="mindfulness">
                    <option value="learning">
                    <option value="focus">
                    <option value="nutrition">
                    <option value="sleep">
                    <option value="planning">
                    <option value="review">
                </datalist>
            </div>

            <!-- Weight / Importance -->
            <div class="form-group">
                <label for="task-weight" class="form-label">
                    Importance
                    <span class="label-hint">(affects completion %)</span>
                </label>
                <div class="weight-selector">
                    <label class="weight-option">
                        <input type="radio" name="weight" value="1" checked>
                        <span class="weight-badge">1</span>
                        <span class="weight-label">Low</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="2">
                        <span class="weight-badge">2</span>
                        <span class="weight-label">Medium</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="3">
                        <span class="weight-badge">3</span>
                        <span class="weight-label">High</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="5">
                        <span class="weight-badge">5</span>
                        <span class="weight-label">Critical</span>
                    </label>
                </div>
            </div>

            <!-- Schedule -->
            <div class="form-group">
                <label class="form-label">Schedule</label>
                <div class="schedule-options">
                    <label class="form-checkbox inline">
                        <input type="checkbox" name="is_recurring" id="is-recurring" checked>
                        <span>Recurring (repeat daily)</span>
                    </label>
                </div>
            </div>

            <!-- Time of Day (Optional) -->
            <div class="form-group">
                <label for="task-time" class="form-label">Preferred Time (Optional)</label>
                <select id="task-time" name="time_of_day" class="form-select">
                    <option value="">Any time</option>
                    <option value="morning">üåÖ Morning (6am-12pm)</option>
                    <option value="afternoon">‚òÄÔ∏è Afternoon (12pm-5pm)</option>
                    <option value="evening">üåÜ Evening (5pm-9pm)</option>
                    <option value="night">üåô Night (9pm-12am)</option>
                </select>
            </div>

            <!-- Link to Goal (Optional) -->
            <div class="form-group">
                <label for="task-goal" class="form-label">Link to Goal (Optional)</label>
                <select id="task-goal" name="goal_id" class="form-select">
                    <option value="">No goal linked</option>
                    <!-- Goals populated dynamically -->
                </select>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="create-task-btn">
                Add Task
            </button>
        </div>
    </form>
</div>

<style>
    .hint {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        margin-top: 0.25rem;
    }

    .label-hint {
        font-weight: 400;
        color: var(--color-text-secondary);
        font-size: 0.75rem;
    }

    .weight-selector {
        display: flex;
        gap: 0.5rem;
    }

    .weight-option {
        flex: 1;
        cursor: pointer;
    }

    .weight-option input {
        display: none;
    }

    .weight-option span {
        display: block;
        text-align: center;
    }

    .weight-badge {
        width: 100%;
        padding: 0.5rem;
        background: var(--color-bg);
        border: 2px solid var(--color-border);
        border-radius: 8px 8px 0 0;
        font-weight: 700;
        font-size: 1.25rem;
        transition: all 0.2s;
    }

    .weight-label {
        padding: 0.25rem;
        background: var(--color-bg);
        border: 2px solid var(--color-border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        font-size: 0.625rem;
        font-weight: 500;
        text-transform: uppercase;
        color: var(--color-text-secondary);
        transition: all 0.2s;
    }

    .weight-option input:checked+.weight-badge {
        border-color: var(--color-primary);
        background: var(--color-primary);
        color: white;
    }

    .weight-option input:checked~.weight-label {
        border-color: var(--color-primary);
        color: var(--color-primary);
    }

    .weight-option:hover .weight-badge {
        border-color: var(--color-primary);
    }

    .schedule-options {
        display: flex;
        gap: 1rem;
    }

    .form-checkbox.inline {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }



    .form-checkbox.inline span {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }
</style>
<script>
    // ==============================
    // Add Task Modal Debug Logging
    // ==============================
    console.log("[AddTaskModal] üß™ Debug script loaded - start");

    document.addEventListener("DOMContentLoaded", function () {
        console.log("[AddTaskModal] DOMContentLoaded fired");

        const modalDialog = document.querySelector(".modal-dialog");
        const form = document.getElementById("add-task-form");
        const trackerIdInput = document.getElementById("tracker-id");
        const descriptionInput = document.getElementById("task-description");
        const categoryInput = document.getElementById("task-category");
        const weightInputs = document.querySelectorAll("input[name='weight']");
        const isRecurringCheckbox = document.getElementById("is-recurring");
        const timeSelect = document.getElementById("task-time");
        const goalSelect = document.getElementById("task-goal");
        const closeButtons = document.querySelectorAll("[data-action='close-modal']");
        const submitBtn = document.getElementById("create-task-btn");

        console.log("[AddTaskModal] Elements found:", {
            modalDialog,
            form,
            trackerIdInput,
            descriptionInput,
            categoryInput,
            weightInputsCount: weightInputs.length,
            isRecurringCheckbox,
            timeSelect,
            goalSelect,
            closeButtonsCount: closeButtons.length,
            submitBtn
        });

        // Helper to log complete current state
        function logFormState(prefix = "[AddTaskModal] Current state") {
            let selectedWeight = null;
            weightInputs.forEach(w => {
                if (w.checked) selectedWeight = w.value;
            });

            const data = {
                tracker_id: trackerIdInput ? trackerIdInput.value : null,
                description: descriptionInput ? descriptionInput.value : null,
                category: categoryInput ? categoryInput.value : null,
                weight: selectedWeight,
                is_recurring: isRecurringCheckbox ? isRecurringCheckbox.checked : null,
                time_of_day: timeSelect ? timeSelect.value : null,
                goal_id: goalSelect ? goalSelect.value : null,
            };
            console.log(prefix, data);
        }

        // ==========================
        // Modal open/close logging
        // ==========================
        if (modalDialog) {
            console.log("[AddTaskModal] Modal dialog exists in DOM");

            // If you have your own open-modal logic elsewhere,
            // you can call logFormState() from there as well.
        } else {
            console.warn("[AddTaskModal] ‚ùó modal-dialog not found");
        }

        closeButtons.forEach((btn, index) => {
            console.log(`[AddTaskModal] Close button #${index + 1} wired`);
            btn.addEventListener("click", function () {
                console.log("[AddTaskModal] ‚ùå Close button clicked", { index });
                logFormState("[AddTaskModal] State at close click");
            });
        });

        // ==========================
        // Field change logging
        // ==========================

        if (descriptionInput) {
            descriptionInput.addEventListener("input", function (e) {
                console.log("[AddTaskModal] üìù Description changed:", e.target.value);
            });
        }

        if (categoryInput) {
            categoryInput.addEventListener("input", function (e) {
                console.log("[AddTaskModal] üè∑Ô∏è Category changed:", e.target.value);
            });
        }

        weightInputs.forEach((input) => {
            input.addEventListener("change", function (e) {
                console.log("[AddTaskModal] ‚öñÔ∏è Weight changed:", e.target.value);
                logFormState("[AddTaskModal] State after weight change");
            });
        });

        if (isRecurringCheckbox) {
            isRecurringCheckbox.addEventListener("change", function (e) {
                console.log("[AddTaskModal] üîÅ is_recurring toggled:", e.target.checked);
                logFormState("[AddTaskModal] State after is_recurring toggle");
            });
        }

        if (timeSelect) {
            timeSelect.addEventListener("change", function (e) {
                console.log("[AddTaskModal] ‚è∞ Time of day changed:", e.target.value);
            });
        }

        if (goalSelect) {
            goalSelect.addEventListener("change", function (e) {
                console.log("[AddTaskModal] üéØ Goal linked changed:", e.target.value);
            });
        }

        // ==========================
        // Form submit logging
        // ==========================
        if (form) {
            console.log("[AddTaskModal] ‚úÖ Form found, attaching submit handler");

            form.addEventListener("submit", function (e) {
                console.log("[AddTaskModal] üöÄ Form submit triggered");

                // If you're using data-ajax and preventing default elsewhere, 
                // you can comment/uncomment this as needed.
                // e.preventDefault();

                // Log raw form data
                const formData = new FormData(form);
                const payload = {};
                formData.forEach((value, key) => {
                    payload[key] = value;
                });

                console.log("[AddTaskModal] üì¶ FormData payload:", payload);
                logFormState("[AddTaskModal] State at submit");

                if (submitBtn) {
                    console.log("[AddTaskModal] Submit button state:", {
                        disabled: submitBtn.disabled,
                        text: submitBtn.innerText
                    });
                }

                console.log("[AddTaskModal] ‚úÖ Submit handler completed");
            });
        } else {
            console.warn("[AddTaskModal] ‚ùó Form #add-task-form not found");
        }

        console.log("[AddTaskModal] üß™ Debug wiring complete - end of script");
    });

    console.log("[AddTaskModal] üß™ Script tag parsed - end");
</script>
