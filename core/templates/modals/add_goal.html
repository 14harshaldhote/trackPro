<!-- Add Goal Modal -->
<div class="modal-dialog" role="document">
    <div class="modal-header">
        <h3 class="modal-title">Set New Goal</h3>
        <button type="button" class="modal-close" data-action="close-modal" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <form id="add-goal-form" method="POST" data-ajax>
        {% csrf_token %}
        <div class="modal-body">
            <!-- Goal Title -->
            <div class="form-group">
                <label for="goal-title" class="form-label">Goal Title *</label>
                <input type="text" id="goal-title" name="title" class="form-input"
                    placeholder="e.g., Run a Marathon, Save $5000" required maxlength="100">
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="goal-description" class="form-label">Description</label>
                <textarea id="goal-description" name="description" class="form-input" rows="2"
                    placeholder="Why is this goal important?"></textarea>
            </div>

            <!-- Target Date -->
            <div class="form-group">
                <label for="target-date" class="form-label">Target Date</label>
                <input type="date" id="target-date" name="target_date" class="form-input" required>
            </div>

            <!-- Goal Type -->
            <div class="form-group">
                <label for="goal-type" class="form-label">Goal Type</label>
                <select id="goal-type" name="goal_type" class="form-select">
                    <option value="habit">Habit Building</option>
                    <option value="achievement">Achievement</option>
                    <option value="project">Project</option>
                </select>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="create-goal-btn">
                Set Goal
            </button>
        </div>
    </form>
</div>

<script>
    (function () {
        const form = document.getElementById('add-goal-form');
        const submitBtn = document.getElementById('create-goal-btn');

        if (!form) {
            console.warn('[AddGoalModal] Form not found');
            return;
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(form);

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span> Creating...';
            }

            try {
                const data = {
                    title: formData.get('title'),
                    description: formData.get('description') || '',
                    target_date: formData.get('target_date'),
                    goal_type: formData.get('goal_type') || 'habit'
                };

                const csrfToken = formData.get('csrfmiddlewaretoken') ||
                    document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                    (window.App ? window.App.getCsrfToken() : '');

                const response = await fetch('/api/goals/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (window.App) {
                        window.App.showToast('success', 'Goal Created', result.message || 'Your goal has been set!');
                        window.App.closeModal();
                        // Refresh goals panel if on goals page
                        if (window.location.pathname.includes('goals')) {
                            window.App.cache.panels.delete(window.location.pathname);
                            window.App.loadPanel(window.location.pathname, false);
                        }
                    } else {
                        alert('Goal created successfully!');
                        window.location.reload();
                    }
                } else {
                    throw new Error(result.error || 'Failed to create goal');
                }
            } catch (error) {
                console.error('[AddGoalModal] Submit error:', error);
                if (window.App) {
                    window.App.showToast('error', 'Error', error.message);
                } else {
                    alert('Error: ' + error.message);
                }
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Set Goal';
                }
            }
        });

        console.log('[AddGoalModal] Form handler initialized');
    })();
</script>