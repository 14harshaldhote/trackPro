<!-- Bulk Edit Modal -->
<div class="modal-header">
    <h2 class="modal-title">Edit <span id="bulk-count">0</span> Tasks</h2>
    <button type="button" class="btn btn-icon" data-action="close-modal" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>

<div class="modal-body">
    <p class="text-muted mb-4">Changes will be applied to all selected tasks.</p>

    <form id="bulk-edit-form" data-validate>
        <!-- Status -->
        <div class="form-group">
            <label class="form-label">Set Status</label>
            <select name="status" class="form-select">
                <option value="">Don't change</option>
                <option value="PENDING">Pending</option>
                <option value="DONE">Complete</option>
                <option value="SKIPPED">Skipped</option>
            </select>
        </div>

        <!-- Category -->
        <div class="form-group">
            <label class="form-label">Set Category</label>
            <input type="text" name="category" class="form-input" placeholder="Leave empty to keep current">
        </div>

        <!-- Move to Tracker -->
        <div class="form-group">
            <label class="form-label">Move to Tracker</label>
            <select name="tracker_id" class="form-select">
                <option value="">Don't move</option>
                {% for t in trackers %}
                <option value="{{ t.id }}">{{ t.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Weight -->
        <div class="form-group">
            <label class="form-label">Set Weight</label>
            <input type="number" name="weight" class="form-input" min="1" max="10"
                placeholder="Leave empty to keep current">
        </div>

        <!-- Time of Day -->
        <div class="form-group">
            <label class="form-label">Set Time of Day</label>
            <select name="time_of_day" class="form-select">
                <option value="">Don't change</option>
                <option value="morning">Morning</option>
                <option value="afternoon">Afternoon</option>
                <option value="evening">Evening</option>
                <option value="anytime">Anytime</option>
            </select>
        </div>

        <input type="hidden" name="task_ids" id="bulk-task-ids">
    </form>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-ghost" data-action="close-modal">Cancel</button>
    <button type="button" class="btn btn-primary" id="bulk-save-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
        </svg>
        Apply Changes
    </button>
</div>

<script>
    (function () {
        const form = document.getElementById('bulk-edit-form');
        const saveBtn = document.getElementById('bulk-save-btn');
        const taskIdsInput = document.getElementById('bulk-task-ids');
        const countSpan = document.getElementById('bulk-count');

        // Get selected task IDs from parent
        const taskIds = window.bulkEditTaskIds || [];
        taskIdsInput.value = taskIds.join(',');
        countSpan.textContent = taskIds.length;

        saveBtn.addEventListener('click', async () => {
            App.setButtonLoading(saveBtn, true);

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.task_ids = taskIds;

            // Only include non-empty values
            Object.keys(data).forEach(key => {
                if (!data[key]) delete data[key];
            });

            try {
                const response = await fetch('/api/tasks/bulk-edit/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': App.getCsrfToken()
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    App.showToast('success', `${taskIds.length} tasks updated`);
                    App.closeModal();
                    App.loadPanel(window.location.pathname, false);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                App.showToast('error', 'Failed to update', error.message);
            } finally {
                App.setButtonLoading(saveBtn, false);
            }
        });
    })();
</script>