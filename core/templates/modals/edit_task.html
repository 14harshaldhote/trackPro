<!-- Edit Task Modal -->
<div class="modal-dialog" role="document">
    <div class="modal-header">
        <h3 class="modal-title">Edit Task</h3>
        <button type="button" class="modal-close" data-action="close-modal" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    {% if task %}
    <form id="edit-task-form" method="POST" data-ajax>
        {% csrf_token %}
        <input type="hidden" name="task_id" value="{{ task.task_instance_id }}">

        <div class="modal-body">
            <!-- Task Description -->
            <div class="form-group">
                <label for="task-description" class="form-label">Task Description *</label>
                <input type="text" id="task-description" name="description" class="form-input"
                    value="{{ task.template.description }}" required maxlength="200" autofocus>
                <div class="field-error" id="description-error"></div>
            </div>

            <!-- Current Status -->
            <div class="form-group">
                <label for="task-status" class="form-label">Status</label>
                <select id="task-status" name="status" class="form-select">
                    <option value="TODO" {% if task.status == 'TODO' %}selected{% endif %}>üìã To Do</option>
                    <option value="IN_PROGRESS" {% if task.status == 'IN_PROGRESS' %}selected{% endif %}>üîÑ In Progress
                    </option>
                    <option value="DONE" {% if task.status == 'DONE' %}selected{% endif %}>‚úÖ Done</option>
                    <option value="SKIPPED" {% if task.status == 'SKIPPED' %}selected{% endif %}>‚è≠Ô∏è Skipped</option>
                    <option value="MISSED" {% if task.status == 'MISSED' %}selected{% endif %}>‚ùå Missed</option>
                    <option value="BLOCKED" {% if task.status == 'BLOCKED' %}selected{% endif %}>üö´ Blocked</option>
                </select>
            </div>

            <!-- Category -->
            <div class="form-group">
                <label for="task-category" class="form-label">Category</label>
                <input type="text" id="task-category" name="category" class="form-input"
                    value="{{ task.template.category }}" placeholder="e.g., health, focus, learning" maxlength="50"
                    list="category-suggestions">
                <datalist id="category-suggestions">
                    <option value="health">
                    <option value="fitness">
                    <option value="mindfulness">
                    <option value="learning">
                    <option value="focus">
                    <option value="nutrition">
                    <option value="sleep">
                    <option value="planning">
                    <option value="review">
                </datalist>
            </div>

            <!-- Weight / Importance -->
            <div class="form-group">
                <label for="task-weight" class="form-label">
                    Importance
                    <span class="label-hint">(affects completion %)</span>
                </label>
                <div class="weight-selector">
                    <label class="weight-option">
                        <input type="radio" name="weight" value="1" {% if task.template.weight == 1 %}checked{% endif %}>
                        <span class="weight-badge">1</span>
                        <span class="weight-label">Low</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="2" {% if task.template.weight == 2 %}checked{% endif %}>
                        <span class="weight-badge">2</span>
                        <span class="weight-label">Medium</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="3" {% if task.template.weight == 3 %}checked{% endif %}>
                        <span class="weight-badge">3</span>
                        <span class="weight-label">High</span>
                    </label>
                    <label class="weight-option">
                        <input type="radio" name="weight" value="5" {% if task.template.weight == 5 %}checked{% endif %}>
                        <span class="weight-badge">5</span>
                        <span class="weight-label">Critical</span>
                    </label>
                </div>
            </div>

            <!-- Time of Day -->
            <div class="form-group">
                <label for="task-time" class="form-label">Preferred Time</label>
                <select id="task-time" name="time_of_day" class="form-select">
                    <option value="anytime" {% if task.template.time_of_day == 'anytime' %}selected{% endif %}>Any time
                    </option>
                    <option value="morning" {% if task.template.time_of_day == 'morning' %}selected{% endif %}>üåÖ Morning
                    </option>
                    <option value="afternoon" {% if task.template.time_of_day == 'afternoon' %}selected{% endif %}>‚òÄÔ∏è
                        Afternoon</option>
                    <option value="evening" {% if task.template.time_of_day == 'evening' %}selected{% endif %}>üåÜ Evening
                    </option>
                    <option value="night" {% if task.template.time_of_day == 'night' %}selected{% endif %}>üåô Night
                    </option>
                </select>
            </div>

            <!-- Notes -->
            <div class="form-group">
                <label for="task-notes" class="form-label">Notes</label>
                <textarea id="task-notes" name="notes" class="form-input" rows="3"
                    placeholder="Add any notes about this task...">{{ task.notes }}</textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-ghost" data-action="close-modal">Cancel</button>
            <button type="submit" class="btn btn-primary" id="save-task-btn">
                Save Changes
            </button>
        </div>
    </form>
    {% else %}
    <div class="modal-body">
        <div class="empty-state">
            <p>Task not found or you don't have permission to edit it.</p>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-ghost" data-action="close-modal">Close</button>
    </div>
    {% endif %}
</div>

<style>
    .label-hint {
        font-weight: 400;
        color: var(--color-text-secondary);
        font-size: 0.75rem;
    }

    .weight-selector {
        display: flex;
        gap: 0.5rem;
    }

    .weight-option {
        flex: 1;
        cursor: pointer;
    }

    .weight-option input {
        display: none;
    }

    .weight-option span {
        display: block;
        text-align: center;
    }

    .weight-badge {
        width: 100%;
        padding: 0.5rem;
        background: var(--color-bg);
        border: 2px solid var(--color-border);
        border-radius: 8px 8px 0 0;
        font-weight: 700;
        font-size: 1.25rem;
        transition: all 0.2s;
    }

    .weight-label {
        padding: 0.25rem;
        background: var(--color-bg);
        border: 2px solid var(--color-border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        font-size: 0.625rem;
        font-weight: 500;
        text-transform: uppercase;
        color: var(--color-text-secondary);
        transition: all 0.2s;
    }

    .weight-option input:checked+.weight-badge {
        border-color: var(--color-primary);
        background: var(--color-primary);
        color: white;
    }

    .weight-option input:checked~.weight-label {
        border-color: var(--color-primary);
        color: var(--color-primary);
    }

    .weight-option:hover .weight-badge {
        border-color: var(--color-primary);
    }
</style>

<script>
    (function () {
        const form = document.getElementById('edit-task-form');
        const submitBtn = document.getElementById('save-task-btn');

        if (!form) {
            console.warn('[EditTaskModal] Form not found - task may not exist');
            return;
        }

        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(form);
            const taskId = formData.get('task_id');

            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span> Saving...';
            }

            try {
                const data = {
                    status: formData.get('status'),
                    notes: formData.get('notes') || '',
                    // Template updates (might not be supported by all APIs)
                    description: formData.get('description'),
                    category: formData.get('category') || '',
                    weight: parseInt(formData.get('weight')) || 1,
                    time_of_day: formData.get('time_of_day') || 'anytime'
                };

                const csrfToken = formData.get('csrfmiddlewaretoken') ||
                    document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                    (window.App ? window.App.getCsrfToken() : '');

                const response = await fetch(`/api/task/${taskId}/edit/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (window.App) {
                        window.App.showToast('success', 'Task Updated', result.message || 'Changes saved successfully');
                        window.App.closeModal();
                        window.App.cache.panels.delete(window.location.pathname);
                        window.App.loadPanel(window.location.pathname, false);
                    } else {
                        alert('Task updated successfully!');
                        window.location.reload();
                    }
                } else {
                    throw new Error(result.error || 'Failed to update task');
                }
            } catch (error) {
                console.error('[EditTaskModal] Submit error:', error);
                if (window.App) {
                    window.App.showToast('error', 'Error', error.message);
                } else {
                    alert('Error: ' + error.message);
                }
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Save Changes';
                }
            }
        });

        console.log('[EditTaskModal] Form handler initialized');
    })();
</script>