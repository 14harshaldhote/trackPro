{% extends 'base.html' %}
{% load tracker_filters %}

{% block title %}Custom Range - {{ tracker.name }}{% endblock %}

{% block content %}
<div class="main-content fade-in">
    <!-- Header with Date Selector -->
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'tracker_detail' tracker.tracker_id %}" class="btn btn-ghost">‚Üê Back</a>
        <h1 style="margin: 1rem 0;">üìä Custom Date Range</h1>
        <p class="text-secondary">{{ tracker.name }}</p>
    </div>

    <!-- Date Range Selector -->
    <div class="card" style="margin-bottom: 2rem;">
        <form method="get" style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Start Date</label>
                <input type="date" name="start" value="{{ start_date|date:'Y-m-d' }}" class="form-input"
                    style="width: auto;">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">End Date</label>
                <input type="date" name="end" value="{{ end_date|date:'Y-m-d' }}" class="form-input"
                    style="width: auto;">
            </div>
            <button type="submit" class="btn btn-primary">Apply Range</button>

            <!-- Quick Presets -->
            <div style="display: flex; gap: 0.5rem; margin-left: auto;">
                <a href="?start={{ today|date:'Y-m-d' }}&end={{ today|date:'Y-m-d' }}"
                    class="btn btn-ghost btn-sm">Today</a>
                <a href="?start={{ today|add_days:-6|date:'Y-m-d' }}&end={{ today|date:'Y-m-d' }}"
                    class="btn btn-ghost btn-sm">Last 7 Days</a>
                <a href="?start={{ today|add_days:-29|date:'Y-m-d' }}&end={{ today|date:'Y-m-d' }}"
                    class="btn btn-ghost btn-sm">Last 30 Days</a>
            </div>
        </form>
    </div>

    <!-- Stats -->
    <div class="grid-3" style="margin-bottom: 2rem;">
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ date_range|length }}</div>
                <div class="stat-label">Days in Range</div>
            </div>
        </div>
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ done_tasks }}/{{ total_tasks }}</div>
                <div class="stat-label">Completed</div>
            </div>
        </div>
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ completion_rate|floatformat:0 }}%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>
    </div>

    <!-- Grid -->
    <div class="card" style="overflow-x: auto;">
        <div class="card-header">
            <h3>{{ start_date|date:"M j" }} - {{ end_date|date:"M j, Y" }}</h3>
        </div>

        <table style="width: 100%; min-width: 600px; border-collapse: collapse; margin-top: 1rem;">
            <thead>
                <tr>
                    <th
                        style="position: sticky; left: 0; z-index: 2; background: var(--color-surface); padding: 1rem; min-width: 200px; border-right: 2px solid var(--color-border);">
                        Task
                    </th>
                    {% for day in date_range %}
                    <th
                        style="text-align: center; padding: 0.5rem; min-width: 60px; {% if day == today %}background: rgba(var(--color-primary-rgb, 2, 119, 189), 0.1);{% endif %}">
                        <div style="font-size: 0.75rem; font-weight: 600;">{{ day|date:"M j" }}</div>
                        <div style="font-size: 0.7rem; color: var(--color-text-secondary);">{{ day|date:"D" }}</div>
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in grid_data %}
                <tr style="border-bottom: 1px solid var(--color-border);">
                    <td
                        style="position: sticky; left: 0; z-index: 1; background: var(--color-surface); padding: 1rem; font-weight: 500; border-right: 2px solid var(--color-border);">
                        <div>{{ row.template.description }}</div>
                        {% if row.template.category %}
                        <span class="badge badge-primary" style="margin-top: 0.25rem; font-size: 0.65rem;">{{
                            row.template.category }}</span>
                        {% endif %}
                    </td>
                    {% for day_info in row.days %}
                    <td
                        style="text-align: center; padding: 0.5rem; {% if day_info.is_today %}background: rgba(var(--color-primary-rgb, 2, 119, 189), 0.05);{% endif %}">
                        {% if day_info.task %}
                        <button onclick="toggleStatus('{{ day_info.task.task_instance_id }}')" class="status-cell"
                            style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid 
                                {% if day_info.status == 'DONE' %}#10B981
                                {% elif day_info.status == 'IN_PROGRESS' %}#3B82F6
                                {% elif day_info.status == 'MISSED' %}#EF4444
                                {% else %}var(--color-border){% endif %}; 
                                background: {% if day_info.status == 'DONE' %}#10B981{% elif day_info.status == 'IN_PROGRESS' %}#3B82F6{% elif day_info.status == 'MISSED' %}#EF4444{% else %}transparent{% endif %}; 
                                cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center justify-content: center; font-size: 1rem;">
                            {% if day_info.status == 'DONE' %}
                            <span style="color: white;">‚úì</span>
                            {% elif day_info.status == 'IN_PROGRESS' %}
                            <span style="color: white;">‚óê</span>
                            {% elif day_info.status == 'MISSED' %}
                            <span style="color: white;">‚úó</span>
                            {% else %}
                            <span style="color: var(--color-text-secondary);">‚óã</span>
                            {% endif %}
                        </button>
                        {% else %}
                        <div style="width: 32px; height: 32px; opacity: 0.3;">-</div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ date_range|length|add:'1' }}" style="text-align: center; padding: 3rem;">
                        <p class="text-secondary">No tasks for this tracker.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Bulk Actions -->
    <div class="card" style="margin-top: 2rem;">
        <h4 style="margin-bottom: 1rem;">Bulk Actions</h4>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button onclick="markAllOverdueMissed()" class="btn btn-ghost">
                Mark Overdue as Missed
            </button>
            <button onclick="selectAllTodo()" class="btn btn-ghost">
                Select All TODO
            </button>
            <button onclick="bulkUpdateSelected('DONE')" class="btn btn-primary">
                Mark Selected as Done
            </button>
        </div>
    </div>
</div>

<script>
    function toggleStatus(taskId) {
        fetch(`/api/task/${taskId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                }
            });
    }

    function markAllOverdueMissed() {
        if (!confirm('Mark all overdue TODO tasks as MISSED?')) return;

        fetch(`/api/tracker/{{ tracker.tracker_id }}/mark-overdue/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}