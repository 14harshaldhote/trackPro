{% extends 'base.html' %}

{% block title %}Monthly Tracker - {{ tracker.name }}{% endblock %}

{% block content %}
<div class="main-content">
    <!-- Header -->
    <div style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <a href="{% url 'tracker_detail' tracker.tracker_id %}" class="btn btn-ghost">‚Üê Back</a>
                <h1 style="margin: 1rem 0;">üìÖ {{ month_name }}</h1>
                <p class="text-secondary">{{ tracker.name }} - Interactive Monthly Tracker</p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-ghost">‚Üê Previous</a>
                <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-ghost">Next ‚Üí</a>
            </div>
        </div>
    </div>

    <!-- Monthly Grid -->
    <div class="card" style="overflow-x: auto;">
        <table style="width: 100%; min-width: 800px; border-collapse: collapse;">
            <thead>
                <tr>
                    <th
                        style="position: sticky; left: 0; z-index: 2; background: var(--color-surface); padding: 1rem; min-width: 200px; border-right: 2px solid var(--color-border);">
                        Activity
                    </th>
                    {% for day in calendar_data.0.days %}
                    <th
                        style="text-align: center; padding: 0.5rem; min-width: 40px; {% if day.is_today %}background: rgba(var(--color-primary-rgb, 2, 119, 189), 0.1);{% endif %}">
                        <div style="font-weight: 600;">{{ day.day }}</div>
                        <div style="font-size: 0.75rem; color: var(--color-text-secondary);">
                            {{ day.date|date:"D" }}
                        </div>
                    </th>
                    {% endfor %}
                    <th style="text-align: center; padding: 1rem; border-left: 2px solid var(--color-border);">
                        Total
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for row in calendar_data %}
                <tr style="border-bottom: 1px solid var(--color-border);">
                    <td
                        style="position: sticky; left: 0; z-index: 1; background: var(--color-surface); padding: 1rem; font-weight: 500; border-right: 2px solid var(--color-border);">
                        <div>{{ row.template.description }}</div>
                        {% if row.template.category %}
                        <span class="badge badge-primary" style="margin-top: 0.25rem;">{{ row.template.category }}</span>
                        {% endif %}
                    </td>
                    {% for day_info in row.days %}
                    <td
                        style="text-align: center; padding: 0.5rem; {% if day_info.is_today %}background: rgba(var(--color-primary-rgb, 2, 119, 189), 0.05);{% endif %}">
                        {% if day_info.task %}
                        <button onclick="toggleTask('{{ day_info.task.task_instance_id }}')"
                            class="task-checkbox {% if day_info.is_done %}checked{% endif %}"
                            id="task-{{ day_info.task.task_instance_id }}"
                            style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid var(--color-border); background: {% if day_info.is_done %}var(--color-primary){% else %}transparent{% endif %}; cursor: pointer; transition: all 0.2s;">
                            {% if day_info.is_done %}
                            <span style="color: white; font-size: 1.2rem;">‚úì</span>
                            {% endif %}
                        </button>
                        {% else %}
                        <div style="width: 32px; height: 32px; opacity: 0.3;">-</div>
                        {% endif %}
                    </td>
                    {% endfor %}
                    <td
                        style="text-align: center; padding: 1rem; font-weight: 600; border-left: 2px solid var(--color-border);">
                        {% with done_count=row.days|length %}
                        {{ row.days|length|add:"0" }}/{{ num_days }}
                        {% endwith %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ num_days|add:'2' }}" style="text-align: center; padding: 3rem;">
                        <p class="text-secondary">No activities configured for this tracker.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Progress Summary -->
    <div class="grid-3" style="margin-top: 2rem;">
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ calendar_data|length }}</div>
                <div class="stat-label">Activities</div>
            </div>
        </div>
        <div class="card">
            <div class="stat-item">
                <div class="stat-value">{{ num_days }}</div>
                <div class="stat-label">Days in Month</div>
            </div>
        </div>
        <div class="card">
            <div class="stat-item">
                <div class="stat-value" id="completion-rate">0%</div>
                <div class="stat-label">Completion Rate</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle task completion
    function toggleTask(taskId) {
        const btn = document.getElementById('task-' + taskId);
        const isChecked = btn.classList.contains('checked');

        fetch(`/api/task/${taskId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.new_status === 'DONE') {
                        btn.classList.add('checked');
                        btn.style.background = 'var(--color-primary)';
                        btn.innerHTML = '<span style="color: white; font-size: 1.2rem;">‚úì</span>';
                    } else {
                        btn.classList.remove('checked');
                        btn.style.background = 'transparent';
                        btn.innerHTML = '';
                    }
                    updateCompletionRate();
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Update completion rate
    function updateCompletionRate() {
        const allCheckboxes = document.querySelectorAll('.task-checkbox');
        const checkedBoxes = document.querySelectorAll('.task-checkbox.checked');

        if (allCheckboxes.length > 0) {
            const rate = (checkedBoxes.length / allCheckboxes.length * 100).toFixed(0);
            document.getElementById('completion-rate').textContent = rate + '%';
        }
    }

    // Calculate initial completion rate
    updateCompletionRate();
</script>
{% endblock %}