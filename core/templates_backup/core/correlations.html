{% extends 'base.html' %}
{% load tracker_filters %}

{% block title %}Correlations - {{ tracker.name }}{% endblock %}

{% block content %}
<div class="main-content">
    <div style="margin-bottom: 2rem;">
        <a href="{% url 'tracker_detail' tracker.tracker_id %}" class="btn btn-ghost">‚Üê Back</a>
        <h1 style="margin: 1rem 0;">üîó Correlations</h1>
        <p class="text-secondary">Relationships between your metrics</p>
    </div>

    {% if heatmap %}
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h3>Correlation Heatmap</h3>
            <p class="text-secondary">Values range from -1 (negative correlation) to +1 (positive correlation)</p>
        </div>
        <img src="data:image/png;base64,{{ heatmap }}" alt="Correlation Heatmap"
            style="width: 100%; max-width: 600px; margin: 0 auto; display: block;">
    </div>
    {% endif %}

    {% if correlations.correlation_matrix %}
    <div class="card">
        <div class="card-header">
            <h3>Correlation Details</h3>
        </div>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--color-border);">
                        <th style="padding: 0.75rem; text-align: left;">Metric 1</th>
                        <th style="padding: 0.75rem; text-align: left;">Metric 2</th>
                        <th style="padding: 0.75rem; text-align: center;">Correlation</th>
                        <th style="padding: 0.75rem; text-align: center;">Significance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for metric1, values in correlations.correlation_matrix.items %}
                    {% for metric2, corr_value in values.items %}
                    {% if metric1 != metric2 %}
                    <tr style="border-bottom: 1px solid var(--color-border);">
                        <td style="padding: 0.75rem;">{{ metric1|title }}</td>
                        <td style="padding: 0.75rem;">{{ metric2|title }}</td>
                        <td style="padding: 0.75rem; text-align: center;">
                            <span
                                class="badge {% if corr_value > 0.5 %}badge-success{% elif corr_value < -0.5 %}badge-warning{% else %}badge-primary{% endif %}">
                                {{ corr_value|floatformat:3 }}
                            </span>
                        </td>
                        <td style="padding: 0.75rem; text-align: center;">
                            {% if correlations.significant|get_item:metric1|get_item:metric2 %}
                            <span class="badge badge-success">Significant</span>
                            {% else %}
                            <span class="badge"
                                style="background: rgba(158, 158, 158, 0.1); color: var(--color-text-secondary);">Not
                                significant</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card">
        <p class="text-secondary">Not enough data for correlation analysis. Need at least 2 metrics with data.</p>
    </div>
    {% endif %}
</div>
{% endblock %}